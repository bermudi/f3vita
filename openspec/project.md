# Project Context

## Purpose

**f3vita** is a storage integrity verification tool for PlayStation Vita. It writes known patterns to storage devices and reads them back to detect:
- Bad sectors
- Fake capacity (counterfeit SD cards)
- Flaky adapters (SD2Vita, etc.)

Named after the popular [f3](https://fight-flash-fraud.readthedocs.io/) tool for desktop systems.

## Target Platforms
- PS Vita (all models: PCH-1000, PCH-2000)
- PS TV (VTE-1000)
- Runs as VitaSDK homebrew (.vpk)

## Tech Stack
- **Language**: C (C99/C11)
- **Toolchain**: VitaSDK (arm-vita-eabi-gcc)
- **Build System**: CMake with VitaSDK macros
- **Graphics**: Basic text rendering (debug font or vita2d)
- **Build Automation**: Python (uv) for helper scripts if needed

## Project Conventions

### Code Style
- C99 standard with VitaSDK extensions
- 4-space indentation
- snake_case for functions and variables
- UPPER_CASE for constants and macros
- Prefix public functions with `f3v_` namespace

### File Organization
```
f3vita/
├── CMakeLists.txt      # Build configuration
├── src/
│   ├── main.c          # Entry point, UI loop
│   ├── storage.c       # File I/O operations
│   ├── pattern.c       # Test pattern generation/verification
│   └── ui.c            # Display and input handling
├── include/
│   └── *.h             # Header files
└── sce_sys/
    ├── icon0.png       # App icon (128x128)
    ├── livearea/
    │   └── contents/
    │       ├── bg.png
    │       └── template.xml
    └── param.sfo       # Generated by CMake
```

### Architecture Patterns
- Single-threaded main loop (simpler, sufficient for this use case)
- State machine for phases: IDLE → WRITE → VERIFY → COMPLETE
- Block-based I/O with 1MB buffer size
- Deterministic pattern: XOR of block index for reproducibility

### Testing Strategy
- Manual testing on real hardware (no emulator available for homebrew)
- Test on multiple storage targets: ux0: (internal), uma0: (USB on PSTV), SD2Vita
- Verify both pass and fail scenarios (use known-bad media if available)

### Git Workflow
- Main branch: `main`
- Feature branches: `feature/<name>`
- Commit messages: imperative mood, reference spec requirements when applicable
- Tag releases: `v1.0.0`

## Domain Context

### PS Vita Storage
- **ux0:** - Primary storage (Memory Card or internal on Slim/PSTV)
- **uma0:** - USB storage (PSTV only)
- **imc0:** - Internal memory (Slim models only)
- **grw0:** - Game card (read-only for homebrew)

### SD2Vita Adapters
Many users use microSD cards via SD2Vita adapters in the game card slot. These are common failure points and primary use case for this tool.

### File System
- Vita uses a proprietary file system
- Standard POSIX-like API available via VitaSDK (sceIo* functions)
- File size limit: theoretically 4GB per file (FAT32-like)

### VitaSDK Key APIs
```c
// File I/O
SceUID sceIoOpen(const char *file, int flags, SceMode mode);
int sceIoRead(SceUID fd, void *data, SceSize size);
int sceIoWrite(SceUID fd, const void *data, SceSize size);
int sceIoClose(SceUID fd);
int sceIoMkdir(const char *dir, SceMode mode);

// Storage info
int sceAppMgrGetDevInfo(const char *dev, uint64_t *max_size, uint64_t *free_size);

// Input
int sceCtrlPeekBufferPositive(int port, SceCtrlData *pad, int count);

// Display (debug font)
int psvDebugScreenInit();
int psvDebugScreenPrintf(const char *format, ...);
```

## Important Constraints

| ID | Constraint |
|----|------------|
| C1 | No external dependencies beyond VitaSDK standard libraries |
| C2 | Single .vpk output for easy distribution |
| C3 | Must handle storage full gracefully (expected condition) |
| C4 | Must allow user cancellation at any time |
| C5 | Memory constrained: ~256MB RAM, use fixed buffers |
| C6 | No network access required |

## External Dependencies

- **VitaSDK**: Toolchain and libraries (https://vitasdk.org/)
- **CMake**: Build system (>= 3.10)
- **vita-toolchain**: Creates SELF and VPK files

## Reference

- [VitaSDK Documentation](https://docs.vitasdk.org/)
- [VitaSDK Samples](https://github.com/vitasdk/samples)
- [f3 (original tool)](https://fight-flash-fraud.readthedocs.io/)
