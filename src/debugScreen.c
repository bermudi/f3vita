/**
 * @file debugScreen.c
 * @brief Simple debug screen implementation for PS Vita
 * Based on VitaSDK samples
 */

#include <psp2/display.h>
#include <psp2/kernel/sysmem.h>
#include <psp2/kernel/threadmgr.h>
#include <string.h>
#include <stdarg.h>
#include <stdio.h>

#include "debugScreen.h"

/* 8x8 font data - simplified bitmap font */
static const unsigned char font_8x8[128][8] = {
    [' '] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    ['!'] = {0x18, 0x18, 0x18, 0x18, 0x18, 0x00, 0x18, 0x00},
    ['"'] = {0x6C, 0x6C, 0x24, 0x00, 0x00, 0x00, 0x00, 0x00},
    ['#'] = {0x6C, 0xFE, 0x6C, 0x6C, 0xFE, 0x6C, 0x00, 0x00},
    ['$'] = {0x18, 0x7E, 0xC0, 0x7C, 0x06, 0xFC, 0x18, 0x00},
    ['%'] = {0xC6, 0xCC, 0x18, 0x30, 0x66, 0xC6, 0x00, 0x00},
    ['&'] = {0x38, 0x6C, 0x38, 0x76, 0xDC, 0xCC, 0x76, 0x00},
    ['\''] = {0x18, 0x18, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00},
    ['('] = {0x0C, 0x18, 0x30, 0x30, 0x30, 0x18, 0x0C, 0x00},
    [')'] = {0x30, 0x18, 0x0C, 0x0C, 0x0C, 0x18, 0x30, 0x00},
    ['*'] = {0x00, 0x66, 0x3C, 0xFF, 0x3C, 0x66, 0x00, 0x00},
    ['+'] = {0x00, 0x18, 0x18, 0x7E, 0x18, 0x18, 0x00, 0x00},
    [','] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x30},
    ['-'] = {0x00, 0x00, 0x00, 0x7E, 0x00, 0x00, 0x00, 0x00},
    ['.'] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00},
    ['/'] = {0x06, 0x0C, 0x18, 0x30, 0x60, 0xC0, 0x00, 0x00},
    ['0'] = {0x7C, 0xC6, 0xCE, 0xD6, 0xE6, 0xC6, 0x7C, 0x00},
    ['1'] = {0x18, 0x38, 0x18, 0x18, 0x18, 0x18, 0x7E, 0x00},
    ['2'] = {0x7C, 0xC6, 0x06, 0x0C, 0x30, 0x60, 0xFE, 0x00},
    ['3'] = {0x7C, 0xC6, 0x06, 0x3C, 0x06, 0xC6, 0x7C, 0x00},
    ['4'] = {0x0C, 0x1C, 0x3C, 0x6C, 0xFE, 0x0C, 0x0C, 0x00},
    ['5'] = {0xFE, 0xC0, 0xFC, 0x06, 0x06, 0xC6, 0x7C, 0x00},
    ['6'] = {0x38, 0x60, 0xC0, 0xFC, 0xC6, 0xC6, 0x7C, 0x00},
    ['7'] = {0xFE, 0x06, 0x0C, 0x18, 0x30, 0x30, 0x30, 0x00},
    ['8'] = {0x7C, 0xC6, 0xC6, 0x7C, 0xC6, 0xC6, 0x7C, 0x00},
    ['9'] = {0x7C, 0xC6, 0xC6, 0x7E, 0x06, 0x0C, 0x78, 0x00},
    [':'] = {0x00, 0x18, 0x18, 0x00, 0x00, 0x18, 0x18, 0x00},
    [';'] = {0x00, 0x18, 0x18, 0x00, 0x00, 0x18, 0x18, 0x30},
    ['<'] = {0x0C, 0x18, 0x30, 0x60, 0x30, 0x18, 0x0C, 0x00},
    ['='] = {0x00, 0x00, 0x7E, 0x00, 0x7E, 0x00, 0x00, 0x00},
    ['>'] = {0x60, 0x30, 0x18, 0x0C, 0x18, 0x30, 0x60, 0x00},
    ['?'] = {0x7C, 0xC6, 0x0C, 0x18, 0x18, 0x00, 0x18, 0x00},
    ['@'] = {0x7C, 0xC6, 0xDE, 0xDE, 0xDC, 0xC0, 0x7C, 0x00},
    ['A'] = {0x38, 0x6C, 0xC6, 0xFE, 0xC6, 0xC6, 0xC6, 0x00},
    ['B'] = {0xFC, 0xC6, 0xC6, 0xFC, 0xC6, 0xC6, 0xFC, 0x00},
    ['C'] = {0x7C, 0xC6, 0xC0, 0xC0, 0xC0, 0xC6, 0x7C, 0x00},
    ['D'] = {0xF8, 0xCC, 0xC6, 0xC6, 0xC6, 0xCC, 0xF8, 0x00},
    ['E'] = {0xFE, 0xC0, 0xC0, 0xFC, 0xC0, 0xC0, 0xFE, 0x00},
    ['F'] = {0xFE, 0xC0, 0xC0, 0xFC, 0xC0, 0xC0, 0xC0, 0x00},
    ['G'] = {0x7C, 0xC6, 0xC0, 0xCE, 0xC6, 0xC6, 0x7E, 0x00},
    ['H'] = {0xC6, 0xC6, 0xC6, 0xFE, 0xC6, 0xC6, 0xC6, 0x00},
    ['I'] = {0x7E, 0x18, 0x18, 0x18, 0x18, 0x18, 0x7E, 0x00},
    ['J'] = {0x06, 0x06, 0x06, 0x06, 0xC6, 0xC6, 0x7C, 0x00},
    ['K'] = {0xC6, 0xCC, 0xD8, 0xF0, 0xD8, 0xCC, 0xC6, 0x00},
    ['L'] = {0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xFE, 0x00},
    ['M'] = {0xC6, 0xEE, 0xFE, 0xD6, 0xC6, 0xC6, 0xC6, 0x00},
    ['N'] = {0xC6, 0xE6, 0xF6, 0xDE, 0xCE, 0xC6, 0xC6, 0x00},
    ['O'] = {0x7C, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0x7C, 0x00},
    ['P'] = {0xFC, 0xC6, 0xC6, 0xFC, 0xC0, 0xC0, 0xC0, 0x00},
    ['Q'] = {0x7C, 0xC6, 0xC6, 0xC6, 0xD6, 0xDE, 0x7C, 0x06},
    ['R'] = {0xFC, 0xC6, 0xC6, 0xFC, 0xD8, 0xCC, 0xC6, 0x00},
    ['S'] = {0x7C, 0xC6, 0xC0, 0x7C, 0x06, 0xC6, 0x7C, 0x00},
    ['T'] = {0xFE, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x00},
    ['U'] = {0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0x7C, 0x00},
    ['V'] = {0xC6, 0xC6, 0xC6, 0xC6, 0x6C, 0x38, 0x10, 0x00},
    ['W'] = {0xC6, 0xC6, 0xC6, 0xD6, 0xFE, 0xEE, 0xC6, 0x00},
    ['X'] = {0xC6, 0xC6, 0x6C, 0x38, 0x6C, 0xC6, 0xC6, 0x00},
    ['Y'] = {0xC6, 0xC6, 0x6C, 0x38, 0x18, 0x18, 0x18, 0x00},
    ['Z'] = {0xFE, 0x06, 0x0C, 0x18, 0x30, 0x60, 0xFE, 0x00},
    ['['] = {0x3C, 0x30, 0x30, 0x30, 0x30, 0x30, 0x3C, 0x00},
    ['\\'] = {0xC0, 0x60, 0x30, 0x18, 0x0C, 0x06, 0x00, 0x00},
    [']'] = {0x3C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x3C, 0x00},
    ['^'] = {0x10, 0x38, 0x6C, 0xC6, 0x00, 0x00, 0x00, 0x00},
    ['_'] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFE, 0x00},
    ['`'] = {0x30, 0x18, 0x0C, 0x00, 0x00, 0x00, 0x00, 0x00},
    ['a'] = {0x00, 0x00, 0x7C, 0x06, 0x7E, 0xC6, 0x7E, 0x00},
    ['b'] = {0xC0, 0xC0, 0xFC, 0xC6, 0xC6, 0xC6, 0xFC, 0x00},
    ['c'] = {0x00, 0x00, 0x7C, 0xC6, 0xC0, 0xC6, 0x7C, 0x00},
    ['d'] = {0x06, 0x06, 0x7E, 0xC6, 0xC6, 0xC6, 0x7E, 0x00},
    ['e'] = {0x00, 0x00, 0x7C, 0xC6, 0xFE, 0xC0, 0x7C, 0x00},
    ['f'] = {0x1C, 0x36, 0x30, 0x7C, 0x30, 0x30, 0x30, 0x00},
    ['g'] = {0x00, 0x00, 0x7E, 0xC6, 0xC6, 0x7E, 0x06, 0x7C},
    ['h'] = {0xC0, 0xC0, 0xFC, 0xC6, 0xC6, 0xC6, 0xC6, 0x00},
    ['i'] = {0x18, 0x00, 0x38, 0x18, 0x18, 0x18, 0x3C, 0x00},
    ['j'] = {0x06, 0x00, 0x0E, 0x06, 0x06, 0x06, 0xC6, 0x7C},
    ['k'] = {0xC0, 0xC0, 0xC6, 0xCC, 0xF8, 0xCC, 0xC6, 0x00},
    ['l'] = {0x38, 0x18, 0x18, 0x18, 0x18, 0x18, 0x3C, 0x00},
    ['m'] = {0x00, 0x00, 0xEC, 0xFE, 0xD6, 0xC6, 0xC6, 0x00},
    ['n'] = {0x00, 0x00, 0xFC, 0xC6, 0xC6, 0xC6, 0xC6, 0x00},
    ['o'] = {0x00, 0x00, 0x7C, 0xC6, 0xC6, 0xC6, 0x7C, 0x00},
    ['p'] = {0x00, 0x00, 0xFC, 0xC6, 0xC6, 0xFC, 0xC0, 0xC0},
    ['q'] = {0x00, 0x00, 0x7E, 0xC6, 0xC6, 0x7E, 0x06, 0x06},
    ['r'] = {0x00, 0x00, 0xDC, 0xE6, 0xC0, 0xC0, 0xC0, 0x00},
    ['s'] = {0x00, 0x00, 0x7E, 0xC0, 0x7C, 0x06, 0xFC, 0x00},
    ['t'] = {0x30, 0x30, 0x7C, 0x30, 0x30, 0x36, 0x1C, 0x00},
    ['u'] = {0x00, 0x00, 0xC6, 0xC6, 0xC6, 0xC6, 0x7E, 0x00},
    ['v'] = {0x00, 0x00, 0xC6, 0xC6, 0xC6, 0x6C, 0x38, 0x00},
    ['w'] = {0x00, 0x00, 0xC6, 0xC6, 0xD6, 0xFE, 0x6C, 0x00},
    ['x'] = {0x00, 0x00, 0xC6, 0x6C, 0x38, 0x6C, 0xC6, 0x00},
    ['y'] = {0x00, 0x00, 0xC6, 0xC6, 0xC6, 0x7E, 0x06, 0x7C},
    ['z'] = {0x00, 0x00, 0xFE, 0x0C, 0x38, 0x60, 0xFE, 0x00},
    ['{'] = {0x0E, 0x18, 0x18, 0x70, 0x18, 0x18, 0x0E, 0x00},
    ['|'] = {0x18, 0x18, 0x18, 0x00, 0x18, 0x18, 0x18, 0x00},
    ['}'] = {0x70, 0x18, 0x18, 0x0E, 0x18, 0x18, 0x70, 0x00},
    ['~'] = {0x76, 0xDC, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
};

/* Display parameters */
#define DISPLAY_WIDTH 960
#define DISPLAY_HEIGHT 544
#define DISPLAY_STRIDE 1024
#define FONT_WIDTH 8
#define FONT_HEIGHT 8
#define CHARS_PER_LINE (DISPLAY_WIDTH / FONT_WIDTH)
#define LINES (DISPLAY_HEIGHT / FONT_HEIGHT)

/* Global state */
static uint32_t *g_framebuffer = NULL;
static int g_cursor_x = 0;
static int g_cursor_y = 0;
static uint32_t g_fg_color = 0xFFFFFFFF; /* White */
static uint32_t g_bg_color = 0xFF000000; /* Black */

void psvDebugScreenInit(void)
{
    /* Allocate framebuffer */
    SceKernelAllocMemBlockOpt opt;
    memset(&opt, 0, sizeof(opt));
    opt.size = sizeof(opt);
    opt.attr = 0x00000004; /* SCE_KERNEL_ALLOC_MEMBLOCK_ATTR_HAS_ALIGNMENT */
    opt.alignment = 256 * 1024;

    SceUID fb_uid = sceKernelAllocMemBlock("display",
                                           SCE_KERNEL_MEMBLOCK_TYPE_USER_RW,
                                           4 * DISPLAY_STRIDE * DISPLAY_HEIGHT,
                                           &opt);

    if (fb_uid < 0)
    {
        return;
    }

    sceKernelGetMemBlockBase(fb_uid, (void **)&g_framebuffer);

    /* Configure display */
    SceDisplayFrameBuf fb;
    memset(&fb, 0, sizeof(fb));
    fb.size = sizeof(fb);
    fb.base = g_framebuffer;
    fb.pitch = DISPLAY_STRIDE;
    fb.pixelformat = SCE_DISPLAY_PIXELFORMAT_A8B8G8R8;
    fb.width = DISPLAY_WIDTH;
    fb.height = DISPLAY_HEIGHT;

    sceDisplaySetFrameBuf(&fb, SCE_DISPLAY_SETBUF_NEXTFRAME);

    /* Clear screen */
    psvDebugScreenClear(0xFF000000);
}

void psvDebugScreenClear(uint32_t color)
{
    if (!g_framebuffer)
        return;

    for (int i = 0; i < DISPLAY_STRIDE * DISPLAY_HEIGHT; i++)
    {
        g_framebuffer[i] = color;
    }

    g_cursor_x = 0;
    g_cursor_y = 0;
}

void psvDebugScreenSetFgColor(uint32_t color)
{
    g_fg_color = color;
}

void psvDebugScreenSetBgColor(uint32_t color)
{
    g_bg_color = color;
}

static void draw_char(unsigned char c, int x, int y)
{
    if (!g_framebuffer)
        return;
    if (c > 127)
        c = '?';

    const unsigned char *glyph = font_8x8[(int)c];

    for (int row = 0; row < FONT_HEIGHT; row++)
    {
        uint32_t *pixel = &g_framebuffer[(y + row) * DISPLAY_STRIDE + x];
        unsigned char bits = glyph[row];

        for (int col = 0; col < FONT_WIDTH; col++)
        {
            if (bits & (0x80 >> col))
            {
                *pixel = g_fg_color;
            }
            else
            {
                *pixel = g_bg_color;
            }
            pixel++;
        }
    }
}

static void newline(void)
{
    g_cursor_x = 0;
    g_cursor_y++;

    if (g_cursor_y >= LINES)
    {
        /* Scroll up */
        memmove(g_framebuffer,
                &g_framebuffer[FONT_HEIGHT * DISPLAY_STRIDE],
                (LINES - 1) * FONT_HEIGHT * DISPLAY_STRIDE * sizeof(uint32_t));

        /* Clear bottom line */
        for (int y = (LINES - 1) * FONT_HEIGHT; y < DISPLAY_HEIGHT; y++)
        {
            for (int x = 0; x < DISPLAY_WIDTH; x++)
            {
                g_framebuffer[y * DISPLAY_STRIDE + x] = g_bg_color;
            }
        }

        g_cursor_y = LINES - 1;
    }
}

int psvDebugScreenPrintf(const char *fmt, ...)
{
    char buffer[512];
    va_list args;

    va_start(args, fmt);
    int len = vsnprintf(buffer, sizeof(buffer), fmt, args);
    va_end(args);

    for (int i = 0; buffer[i] != '\0'; i++)
    {
        char c = buffer[i];

        if (c == '\n')
        {
            newline();
        }
        else if (c == '\r')
        {
            g_cursor_x = 0;
        }
        else if (c == '\t')
        {
            g_cursor_x = (g_cursor_x + 4) & ~3;
            if (g_cursor_x >= CHARS_PER_LINE)
            {
                newline();
            }
        }
        else
        {
            draw_char(c, g_cursor_x * FONT_WIDTH, g_cursor_y * FONT_HEIGHT);
            g_cursor_x++;

            if (g_cursor_x >= CHARS_PER_LINE)
            {
                newline();
            }
        }
    }

    return len;
}

void psvDebugScreenSetXY(int x, int y)
{
    g_cursor_x = x;
    g_cursor_y = y;
}

int psvDebugScreenGetX(void)
{
    return g_cursor_x;
}

int psvDebugScreenGetY(void)
{
    return g_cursor_y;
}